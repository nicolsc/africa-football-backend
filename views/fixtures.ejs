<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Fixtures</title>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script type="text/javascript">
    	$(document).ready(function(){
    		$('#btn-new').on('click', function(evt){
	    		var params = {};
          $('#new-fixture input[type=text]').each(function(idx, item){
            params[item.id] = item.value;
          });
	    		$.ajax({type:'POST', url:'/fixtures/new', data:params, dataType:'json', success:function(result){
            $('#result').removeClass('error').addClass('success').html('Success - Fixture id : '+result._id).show().fadeOut(3000);
            refresh();
	    		}, error:function(err){
            console.log('err', err);
	    			$('#result').addClass('error').removeClass('success').html('Error - '+err).show().fadeOut(3000);
	    		}});
	    	});
    	});
      function refresh(){
        $.ajax({type:'GET', url:'/fixtures', dataType:'jsonp', success:function(result){
          console.log('success', result);
          $('tbody tr.fixture').remove();
          result.reverse().forEach(function(item, idx){
            $('tbody').prepend(fixtureTpl(item, result.length-idx));
          });

        }, error:function(err){
          console.log('err', err);
        }});
      }
      function fixtureTpl(fixture, index){
        if (!fixture){
          return "";
        }
        return "<tr class='fixture'><td>"+index+".</td><td>"+fixture.stage+"</td><td>"+fixture.team1+"</td><td>"+fixture.team2+"</td><td>"+new Date(fixture.startDate).toLocaleString()+"</td><td>"+fixture.score+"</td><td><input type='button' value='X' class='btn-del' />&nbsp;<input type='button' value='edit' class='btn-edit' /></td></tr>";
      }
    </script>
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <h1>2013 Fixtures</h1>
    <div id="result"></div>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Stage</th>
          <th>Team #1</th>
          <th>Team #2</th>
          <th>Date</th>
          <th>Score</th>
          <th>&nbsp;</th>
        </tr>
      </thead>
      <tbody>
    <% fixtures && fixtures.forEach(function(fixture, idx){
      %>
        <tr class='fixture'>
          <td><%=idx+1%>.</td>
          <td><%=fixture.stage%></td>
          <td><%=fixture.team1%></td>
          <td><%=fixture.team2%></td>
          <td><%=fixture.date && fixture.date.toLocaleString()%></td>
          <td><%=fixture.score%></td>
          <td><input type="button" value="X" class="btn-del" />&nbsp;<input type="button" value="edit" class="btn-edit" /></td>
        </tr>

    <%}); %>
        <tr id="new-fixture">
          <td>&nbsp;</td>
          <td><input type="text" id="stage" /></td>
          <td><input type="text" id="team1" /></td>
          <td><input type="text" id="team2" /></td>
          <td><input type="text" id="date" /></td>
          <td><input type="text" id="score" /></td>
          <td><input type="button" id="btn-new" value="Add"></td>
        </tr>
      </tbody>
    </table>
  </body>
</html>